<!DOCTYPE html>  <html> <head>   <title>future.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="api.html">                 api.coffee               </a>                                           <a class="source" href="cache.html">                 cache.coffee               </a>                                           <a class="source" href="cafeaulife.html">                 cafeaulife.coffee               </a>                                           <a class="source" href="future.html">                 future.coffee               </a>                                           <a class="source" href="gc.html">                 gc.coffee               </a>                                           <a class="source" href="menagerie.html">                 menagerie.coffee               </a>                                           <a class="source" href="rules.html">                 rules.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               future.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>This module is part of <a href="http://recursiveuniver.se">recursiveuniver.se</a>.</p>

<h2>Future Module</h2>

<p>The Future Module provides methods for computing the future of a pattern, taking into account its ability to grow beyond
the size of its container square.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h3>The Life "Universe"</h3>

<p>This module mixes special case functionality for computing the <code>future</code> of a square into <code>Square</code> and <code>Cell</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h3>Baseline Setup</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">_ = </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;underscore&#39;</span><span class="p">)</span>
<span class="nx">exports</span> <span class="o">?=</span> <span class="nb">window</span> <span class="o">or</span> <span class="k">this</span>

<span class="nv">exports.mixInto = </span><span class="nf">({Square, Cell}) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <h3>Recap: Squares</h3>

<p><img src="block_laying_seed.png" alt="Block laying seed" title="" /></p>

<p><em>(A small pattern that creates a block-laying switch engine, a "puffer train" that grows forever.)</em></p>

<p>HashLife operates on square regions of the board, with the length of the side of each square being a natural power of two
(<code>2^1 -&gt; 2</code>, <code>2^2 -&gt; 4</code>, <code>2^3 -&gt; 8</code>...). Cells are not considered squares. Therefore, the smallest possible square
(of size <code>2^1</code>) has cells for each of its four quadrants, while all larger squares (of size <code>2^n</code>) have squares of one smaller
size (<code>2^(n-1)</code>) for each of their four quadrants.</p>

<p>For example, a square of size eight (<code>2^3</code>) is composed of four squares of size four (<code>2^2</code>):</p>

<pre><code>nw         ne
  ....|....
  ....|....
  ....|....
  ....|....
  ————#————
  ....|....
  ....|....
  ....|....
  ....|....
sw         se
</code></pre>

<p>The squares of size four are in turn each composed of four squares of size two (<code>2^1</code>):</p>

<pre><code>nw           ne
  ..|..|..|..
  ..|..|..|..
  ——+——|——+——
  ..|..|..|..
  ..|..|..|..
  —————#—————
  ..|..|..|..
  ..|..|..|..
  ——+——|——+——
  ..|..|..|..
  ..|..|..|..
sw           se
</code></pre>

<p>And those in turn are each composed of four cells, which cannot be subdivided. (For simplicity, a Cafe au Life
board is represented as one such large square, although the HashLife
algorithm can be used to handle any board shape by tiling it with squares.)</p>

<p>The key principle behind HashLife is taking advantage of redundancy. Therefore, two squares with the same alive and dead cells
are always represented by the same, immutable square objects. HashLife exploits repetition and redundancy by making all squares
idempotent and unique. In other words, if two squares contain the same sequence of cells, they are represented by the same
instance of class <code>Square</code>. For example, there is exactly one representation of a square of size two containing four empty cells:</p>

<pre><code>nw  ne
  ..
  ..
sw  sw
</code></pre>

<p>And thus, a square of size four containing sixteen empty cells is represented as four references to the exact same square of
size two containing four empty cells:</p>

<pre><code>nw     ne
  ..|..
  ..|..
  --+--
  ..|..
  ..|..
sw     se
</code></pre>

<p>And likewise a square of size eight containing sixty-four empty cells is represented as four references to the exact same
square of size four containing sixteen empty cells.</p>

<pre><code>nw         ne
  ....|....
  ....|....
  ....|....
  ....|....
  ----+----
  ....|....
  ....|....
  ....|....
  ....|....
sw         se
</code></pre>

<p>Obviously, the same goes for any configuration of alive and dead cells: There is one unique representation for any possible
square and each of its four quadrants is a reference to a unique representation of a smaller square or cell.</p>

<h3>The Speed of Light</h3>

<p>In Life, the "Speed of Light" or "<em>c</em>" is one cell vertically, horizontally, or diagonally in any direction. Meaning,
that cause and effect cannot travel faster than <em>c</em>.</p>

<p>One consequence of this fundamental limit is that given a square of size <code>2^n | n &gt; 1</code> at time <code>t</code>, HashLife has all
the information it needs to calculate the alive and dead cells for the inner square of size <code>2^n - 2</code> at time <code>t+1</code>.
For example, if HashLife has this square at time <code>t</code>:</p>

<pre><code>nw        ne
  ....|....
  ....|....
  ....|....
  ....|....
  ----+----
  ....|....
  ....|....
  ....|....
  ....|....
sw        se
</code></pre>

<p>HashLife can calculate this square at time <code>t+1</code>:</p>

<pre><code>nw         ne

   ...|...
   ...|...
   ...|...
   ---+---
   ...|...
   ...|...
   ...|...

sw         se
</code></pre>

<p>And this square at time <code>t+2</code>:</p>

<pre><code>nw         ne


    ..|..
    ..|..
    --+--
    ..|..
    ..|..


sw         se
</code></pre>

<p>And this square at time <code>t+3</code>:</p>

<pre><code>nw        ne



     ..
     ..



sw        se
</code></pre>

<p>This is because no matter what is in the cells surrounding our square, their effects cannot propagate
faster than the speed of light, one row inward from the edge every step in time.</p>

<p>HashLife takes advantage of this by storing enough information to quickly look up the shrinking
'future' for every square of size <code>2^n | n &gt; 1</code>. The information is called a square's <em>result</em>.</p>

<h2>Computing the result for squares</h2>

<p><img src="block_laying_seed_2.png" alt="Block laying seed" title="" /></p>

<p><em>(Another small pattern that creates a block-laying switch engine, a "puffer train" that grows forever.)</em></p>

<p>Let's revisit the obvious: Cells do not have results. Also, Squares of size two do not have results,
because at time <code>t+1</code>, cells outside of the square will affect every cell in the square.</p>

<p>The smallest square that computes a result is of size four (<code>2^2</code>). Its result is a square of
size two (<code>2^1</code>) representing the state of those cells at time <code>t+1</code>:</p>

<pre><code>....
.++.
.++.
....
</code></pre>

<p>The computation of the four inner <code>+</code> cells from their adjacent eight cells is straightforward and
is calculated from the basic 2-3 rules or looked up from a table with 65K entries.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h2>Recursively constructing squares of size eight (and larger)</h2>

<p><img src="LWSS.gif" alt="Lightweight Spaceship" title="" /></p>

<p><em>(A small pattern that moves.)</em></p>

<p>Now let's consider a square of size eight (or larger). For the moment, we can ignore the question of what happens
when a square is not in the cache, because when dealing with squares of size eight, we only ever need
to look up squares of size four, and they are all seeded in the cache. (Once we have established how
to construct the result for a square of size eight, including its result and velocity, we will be able
to write out <code>.find</code> method to handle looking up squares of size eight and dealing with cache 'misses'
by constructing a new square.)</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Here's our class for recursively computible squares. We'll actually use this for all squares we build on the fly.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">class</span> <span class="nx">Square</span><span class="p">.</span><span class="nx">RecursivelyComputable</span> <span class="k">extends</span> <span class="nx">Square</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>We know how to obtain any square of size four using <code>cache.find</code>. So what we need is a way to compute
the result for any arbitrary square of size eight or larger from quadrant squares one level smaller.</p>

<p>Our goal is to compute a result that looks like this (the lines and crosses are part of the result):</p>

<pre><code>nw        ne

    +--+
    |..|
    |..|
    +--+

sw        se
</code></pre>

<p>Given that we know the result for each of those four squares, we can start building an intermediate result.
The constructor for <code>IntermediateResult</code> takes a square and constructs th epieces of an intermediate square,
one that is half way between the level of the square and the level of the square's eventual result.</p>

<p>We'll step through that process in the constructor piece by piece.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <h3>Making an Intermediate Square from a Square</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>An intermediate square is half-way in size between a square of size 2^n and 2^(n-1). For a square of size
eight, its intermediate square would be size six. Instead of having four quadrants, intermediate squares have
nine components.</p>

<p>For performace reasons, we don't check, however each component must be a square and not a cell. Thus, you cannot
make an intermediate square from a square of size four.</p>

<p>One way to make an intermediate square is to chop a square up into overlapping
subsquares, and take the result of each subsquare. If the square is level <code>n</code>, and
the subsquares are level <code>n-1</code>, the intermediate square will be at time <code>T+2^(n-3)</code>.</p>

<p>For example, a square of size eight (level 3) can be chopped into overlapping squares of size
four (level 2). Since the result of a square of size four is <code>T+2^0</code> in its future, the
intermediate square constructed from the results of squares of size four will be at time <code>T+1</code>
relative to the square of size eight.</p>

<p>First, Let's look at our square of size eight made up of four component squares of size four (the lines
and crosses are part of the components):</p>

<pre><code>nw        ne
  +--++--+
  |..||..|
  |..||..|
  +--++--+
  +--++--+
  |..||..|
  |..||..|
  +--++--+
sw        se
</code></pre>

<p>We can take the results of those four quadrants and add them to our intermediate square</p>

<pre><code>nw        ne

   nw..ne
   nw..ne
   ......
   ......
   sw..se
   sw..se

sw        se
</code></pre>

<p>We will see below the exact mechanism for extracting the results, the important thing for the moment is
the idea that we have four squares 'built in' that we're going to use to get those results.</p>

<p>We can also derive four overlapping squares, these representing <code>nn</code>, <code>ee</code>, <code>ss</code>, and <code>ww</code>:</p>

<pre><code>     nn
  ..+--+..        ..+--+..
  ..|..|..        ..|..|..
  +-|..|-+        +--++--+
  |.+--+.|      w |..||..| e
  |.+--+.|      w |..||..| e
  +-|..|-+        +--++--+
  ..|..|..        ..|..|..
  ..+--+..        ..+--+..
     ss
</code></pre>

<p>Deriving these from our four component squares is straightforward, and when we take their results,
we fill in four of the five missing blanks for our intermediate square:</p>

<pre><code>nw        ne

   ..nn..
   ..nn..
   ww..ee
   ww..ee
   ..ss..
   ..ss..

sw        se
</code></pre>

<p>We use a similar method to derive a center square:</p>

<pre><code>nw        ne

   ......
   .+--+.
   .|..|.
   .|..|.
   .+--+.
   ......

sw        se
</code></pre>

<p>And we extract its result square accordingly:</p>

<pre><code>nw        ne

   ......
   ......
   ..cc..
   ..cc..
   ......
   ......

sw        se
</code></pre>

<p>Given this basic pattern, let's see how we actually do it.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <h3>Making a Square from an Intermediate Square</h3>

<p>We start with a function that maps a square to the nine sub-squares of an intermediate square</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@square_to_intermediate_map: </span><span class="nf">(square) -&gt;</span>
      <span class="nv">nw: </span><span class="nx">square</span><span class="p">.</span><span class="nx">nw</span>
      <span class="nv">ne: </span><span class="nx">square</span><span class="p">.</span><span class="nx">ne</span>
      <span class="nv">se: </span><span class="nx">square</span><span class="p">.</span><span class="nx">se</span>
      <span class="nv">sw: </span><span class="nx">square</span><span class="p">.</span><span class="nx">sw</span>
      <span class="nv">nn:</span>
        <span class="nv">nw: </span><span class="nx">square</span><span class="p">.</span><span class="nx">nw</span><span class="p">.</span><span class="nx">ne</span>
        <span class="nv">ne: </span><span class="nx">square</span><span class="p">.</span><span class="nx">ne</span><span class="p">.</span><span class="nx">nw</span>
        <span class="nv">se: </span><span class="nx">square</span><span class="p">.</span><span class="nx">ne</span><span class="p">.</span><span class="nx">sw</span>
        <span class="nv">sw: </span><span class="nx">square</span><span class="p">.</span><span class="nx">nw</span><span class="p">.</span><span class="nx">se</span>
      <span class="nv">ee:</span>
        <span class="nv">nw: </span><span class="nx">square</span><span class="p">.</span><span class="nx">ne</span><span class="p">.</span><span class="nx">sw</span>
        <span class="nv">ne: </span><span class="nx">square</span><span class="p">.</span><span class="nx">ne</span><span class="p">.</span><span class="nx">se</span>
        <span class="nv">se: </span><span class="nx">square</span><span class="p">.</span><span class="nx">se</span><span class="p">.</span><span class="nx">ne</span>
        <span class="nv">sw: </span><span class="nx">square</span><span class="p">.</span><span class="nx">se</span><span class="p">.</span><span class="nx">nw</span>
      <span class="nv">ss:</span>
        <span class="nv">nw: </span><span class="nx">square</span><span class="p">.</span><span class="nx">sw</span><span class="p">.</span><span class="nx">ne</span>
        <span class="nv">ne: </span><span class="nx">square</span><span class="p">.</span><span class="nx">se</span><span class="p">.</span><span class="nx">nw</span>
        <span class="nv">se: </span><span class="nx">square</span><span class="p">.</span><span class="nx">se</span><span class="p">.</span><span class="nx">sw</span>
        <span class="nv">sw: </span><span class="nx">square</span><span class="p">.</span><span class="nx">sw</span><span class="p">.</span><span class="nx">se</span>
      <span class="nv">ww:</span>
        <span class="nv">nw: </span><span class="nx">square</span><span class="p">.</span><span class="nx">nw</span><span class="p">.</span><span class="nx">sw</span>
        <span class="nv">ne: </span><span class="nx">square</span><span class="p">.</span><span class="nx">nw</span><span class="p">.</span><span class="nx">se</span>
        <span class="nv">se: </span><span class="nx">square</span><span class="p">.</span><span class="nx">sw</span><span class="p">.</span><span class="nx">ne</span>
        <span class="nv">sw: </span><span class="nx">square</span><span class="p">.</span><span class="nx">sw</span><span class="p">.</span><span class="nx">nw</span>
      <span class="nv">cc:</span>
        <span class="nv">nw: </span><span class="nx">square</span><span class="p">.</span><span class="nx">nw</span><span class="p">.</span><span class="nx">se</span>
        <span class="nv">ne: </span><span class="nx">square</span><span class="p">.</span><span class="nx">ne</span><span class="p">.</span><span class="nx">sw</span>
        <span class="nv">se: </span><span class="nx">square</span><span class="p">.</span><span class="nx">se</span><span class="p">.</span><span class="nx">nw</span>
        <span class="nv">sw: </span><span class="nx">square</span><span class="p">.</span><span class="nx">sw</span><span class="p">.</span><span class="nx">ne</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>In order to work on our intermediate square, we want to map functions across all of its keys, such
as canonicalizing each value, taking the result of each value, or taking the result at a certain time
in the future. We'll derive those methods later, for now we hand-wave that they exist.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@map_fn: </span><span class="nf">(fn) -&gt;</span>
      <span class="nf">(parameter_hash) -&gt;</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">reduce</span> <span class="nx">parameter_hash</span><span class="p">,</span> <span class="nf">(acc, value, key) -&gt;</span>
          <span class="nx">acc</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
          <span class="nx">acc</span>
        <span class="p">,</span> <span class="p">{}</span>

    <span class="vi">@take_the_canonicalized_values: </span><span class="nx">@map_fn</span><span class="p">(</span>
      <span class="nf">(quadrants) -&gt;</span>
        <span class="nx">Square</span><span class="p">.</span><span class="nx">canonicalize</span><span class="p">(</span><span class="nx">quadrants</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="vi">@take_the_results: </span><span class="nx">@map_fn</span><span class="p">(</span>
      <span class="nf">(square) -&gt;</span>
        <span class="nx">square</span><span class="p">.</span><span class="nx">result</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="vi">@take_the_results_at_time: </span><span class="nf">(t) -&gt;</span>
      <span class="nx">@map_fn</span><span class="p">(</span>
        <span class="nf">(square) -&gt;</span>
          <span class="nx">square</span><span class="p">.</span><span class="nx">result_at_time</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
      <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Okay, we started with a square of size <code>2^n</code>, and we make an intermediate square of size
<code>2^(n-.5). Given an intermediate square, we can make a square of size</code>2^(n-1)<code>that is forward in time of the
intermediate square by taking the result of four overlapping squares, also of size</code>2^(n-1)`.</p>

<pre><code>nw        ne  nw        ne

   nwnn..        ..nnne
   nwnn..        ..nnne
   wwcc..        ..ccee
   wwcc..        ..ccee
   ......        ......
   ......        ......

sw        se  sw        se

nw        ne  nw        ne

   ......        ......
   ......        ......
   wwcc..        ..ccee
   wwcc..        ..ccee
   swss..        ..ssse
   swss..        ..ssse

sw        se  sw        se
</code></pre>

<p>As you'll see below, we use <code>take_the_results</code> or <code>take_the_results_at_time(t)</code></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@intermediate_to_subsquares_map: </span><span class="nf">(intermediate_square) -&gt;</span>
      <span class="nv">nw:</span>
        <span class="nv">nw: </span><span class="nx">intermediate_square</span><span class="p">.</span><span class="nx">nw</span>
        <span class="nv">ne: </span><span class="nx">intermediate_square</span><span class="p">.</span><span class="nx">nn</span>
        <span class="nv">se: </span><span class="nx">intermediate_square</span><span class="p">.</span><span class="nx">cc</span>
        <span class="nv">sw: </span><span class="nx">intermediate_square</span><span class="p">.</span><span class="nx">ww</span>
      <span class="nv">ne:</span>
        <span class="nv">nw: </span><span class="nx">intermediate_square</span><span class="p">.</span><span class="nx">nn</span>
        <span class="nv">ne: </span><span class="nx">intermediate_square</span><span class="p">.</span><span class="nx">ne</span>
        <span class="nv">se: </span><span class="nx">intermediate_square</span><span class="p">.</span><span class="nx">ee</span>
        <span class="nv">sw: </span><span class="nx">intermediate_square</span><span class="p">.</span><span class="nx">cc</span>
      <span class="nv">se:</span>
        <span class="nv">nw: </span><span class="nx">intermediate_square</span><span class="p">.</span><span class="nx">cc</span>
        <span class="nv">ne: </span><span class="nx">intermediate_square</span><span class="p">.</span><span class="nx">ee</span>
        <span class="nv">se: </span><span class="nx">intermediate_square</span><span class="p">.</span><span class="nx">se</span>
        <span class="nv">sw: </span><span class="nx">intermediate_square</span><span class="p">.</span><span class="nx">ss</span>
      <span class="nv">sw:</span>
        <span class="nv">nw: </span><span class="nx">intermediate_square</span><span class="p">.</span><span class="nx">ww</span>
        <span class="nv">ne: </span><span class="nx">intermediate_square</span><span class="p">.</span><span class="nx">cc</span>
        <span class="nv">se: </span><span class="nx">intermediate_square</span><span class="p">.</span><span class="nx">ss</span>
        <span class="nv">sw: </span><span class="nx">intermediate_square</span><span class="p">.</span><span class="nx">sw</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>The results of those could be combined like this to form the final square of size `2^(n-1):</p>

<pre><code>nw        ne

   ......
   .nwne.
   .nwne.
   .swse.
   .swse.
   ......

sw        se
</code></pre>

<p>We're not going to do that here, we're just responsible for the geometry.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>We now define some initialization for a recursively computible square,
starting with the result and including some memoized intermediate results
that speed things up for us.</p>

<p>The memoizing is a little more bespoke than you would usually see. Normally,
you would use something like;</p>

<p>@some<em>memoized</em>method = <em>.memoize( ->
    "method</em>body<em>goes</em>here"
  )</p>

<p>However, rolling our own memoize infrastructure allows us to construct
the <code>children</code> method that shows us which squares are logically related to any given
square, by dint of being its quadrants or result at any time in the future</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">initialize: </span><span class="o">-&gt;</span>
      <span class="k">super</span><span class="p">()</span>
      <span class="vi">@memoized = </span><span class="p">{}</span>

    <span class="vi">@memoize: </span><span class="nf">(name, method_body) -&gt;</span>
      <span class="nf">(args...) -&gt;</span>
        <span class="nv">index = </span><span class="nx">name</span> <span class="o">+</span> <span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="nx">args</span><span class="p">,</span> <span class="nf">(arg) -&gt;</span> <span class="s2">&quot;_#{arg}&quot;</span> <span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="nx">@get_memo</span><span class="p">(</span><span class="nx">index</span><span class="p">)</span> <span class="o">or</span> <span class="nx">@set_memo</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">method_body</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">...))</span>

    <span class="nv">get_memo: </span><span class="nf">(index) -&gt;</span>
      <span class="nx">@memoized</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span>

    <span class="nv">set_memo: </span><span class="nf">(index, square) -&gt;</span>
      <span class="nx">@memoized</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span> <span class="o">=</span> <span class="nx">square</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>We now have everything we need to compute the
result of any square of size eight or larger, any time in the future from time <code>T+1</code> to time <code>T+2^(n-1)</code>
where <code>n</code> is the level of the square.</p>

<p>The naïve result is obtained as follows: We construct an intermediate square from subresults (moving
forward to <code>T+2^(n-2)</code>), and then we obtain its overlapping squares and take <em>their</em> results (moving
forward <code>2^(n-2)</code> again, for a total advance of <code>2^(n-1)</code>).</p>

<p>The only complication is that we memoize the result for performance... This is HashLife after all, and we
do not like to repeat ourselves in either Space or Time.</p>

<p>Of course, there's another refinement: Instead of naïvely writinga method, we take our mapping functions
from above and chain them together with the <code>sequence</code> method. <code>_.compose(f, g, h)(x)</code> -> <code>f(g(h(x)))</code>,
whereas <code>sequence(f, g, h)(x)</code> -> <code>h(g(f(x)))</code>. That doesn't look like much, but a better way to put it is:</p>

<p>(x) ->
    <em>temp = f(x)
    _temp = g(</em>temp)
    <em>temp = h(</em>temp)
    _temp</p>

<p>In other words, <code>sequence</code> is a poor man's monad. It behaves like just writing a function line by line, but it does
allow us to refactor the way we glue these algorithms together later if we want. For example (hint, hint) if we
wanted to do a little garbage collection of the cache, we could patch the way <code>sequence</code> works without having to rewrite
any of the functions <code>sequence</code> glues together.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@sequence: </span><span class="nf">(fns...) -&gt;</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">compose</span><span class="p">(</span><span class="nx">fns</span><span class="p">.</span><span class="nx">reverse</span><span class="p">()...)</span>

    <span class="nv">result:</span>
      <span class="nx">@memoize</span> <span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
        <span class="nx">Square</span><span class="p">.</span><span class="nx">canonicalize</span><span class="p">(</span>
          <span class="nx">Square</span><span class="p">.</span><span class="nx">RecursivelyComputable</span><span class="p">.</span><span class="nx">sequence</span><span class="p">(</span>
            <span class="nx">Square</span><span class="p">.</span><span class="nx">RecursivelyComputable</span><span class="p">.</span><span class="nx">square_to_intermediate_map</span>
            <span class="nx">Square</span><span class="p">.</span><span class="nx">RecursivelyComputable</span><span class="p">.</span><span class="nx">take_the_canonicalized_values</span>
            <span class="nx">Square</span><span class="p">.</span><span class="nx">RecursivelyComputable</span><span class="p">.</span><span class="nx">take_the_results</span>
            <span class="nx">Square</span><span class="p">.</span><span class="nx">RecursivelyComputable</span><span class="p">.</span><span class="nx">intermediate_to_subsquares_map</span>
            <span class="nx">Square</span><span class="p">.</span><span class="nx">RecursivelyComputable</span><span class="p">.</span><span class="nx">take_the_canonicalized_values</span>
            <span class="nx">Square</span><span class="p">.</span><span class="nx">RecursivelyComputable</span><span class="p">.</span><span class="nx">take_the_results</span>
          <span class="p">)(</span><span class="k">this</span><span class="p">)</span>
        <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>What if we don't want to move so far forward in time? Well, we don't have to. First, let's assume that
we have a method called <code>result_at_time</code>. If that's the case, when we generate an intermediate square,
we can generate one that is less than <code>2^(n-2)</code> generations forward:</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Armed with this one additional function, we can write a general method for determining the result
of a square at an arbitrary point forward in time. Modulo some error checking, we check and see whether
we are moving forward more or less than half as much as the maimum amount. If it's more than half, we
start by generating the intermediate square from results. If it's less than half, we start by generating
the intermediate squre by cropping.</p>

<p>These are methods on squares and not just recursively computible squares, because they need to work on
squares of level 1 and 2.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">result_at_time:</span>
      <span class="nx">@memoize</span> <span class="s1">&#39;result_at_time&#39;</span><span class="p">,</span> <span class="nf">(t) -&gt;</span>
        <span class="k">if</span> <span class="nx">t</span> <span class="o">is</span> <span class="mi">0</span>
          <span class="nx">Square</span><span class="p">.</span><span class="nx">canonicalize</span>
            <span class="nv">nw: </span><span class="nx">@nw</span><span class="p">.</span><span class="nx">se</span>
            <span class="nv">ne: </span><span class="nx">@ne</span><span class="p">.</span><span class="nx">sw</span>
            <span class="nv">se: </span><span class="nx">@se</span><span class="p">.</span><span class="nx">nw</span>
            <span class="nv">sw: </span><span class="nx">@sw</span><span class="p">.</span><span class="nx">ne</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">t</span> <span class="o">&lt;=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">@level</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
          <span class="nx">Square</span><span class="p">.</span><span class="nx">canonicalize</span><span class="p">(</span>
            <span class="nx">Square</span><span class="p">.</span><span class="nx">RecursivelyComputable</span><span class="p">.</span><span class="nx">sequence</span><span class="p">(</span>
              <span class="nx">Square</span><span class="p">.</span><span class="nx">RecursivelyComputable</span><span class="p">.</span><span class="nx">square_to_intermediate_map</span>
              <span class="nx">Square</span><span class="p">.</span><span class="nx">RecursivelyComputable</span><span class="p">.</span><span class="nx">take_the_canonicalized_values</span>
              <span class="nx">Square</span><span class="p">.</span><span class="nx">RecursivelyComputable</span><span class="p">.</span><span class="nx">take_the_results_at_time</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
              <span class="nx">Square</span><span class="p">.</span><span class="nx">RecursivelyComputable</span><span class="p">.</span><span class="nx">intermediate_to_subsquares_map</span>
              <span class="nx">Square</span><span class="p">.</span><span class="nx">RecursivelyComputable</span><span class="p">.</span><span class="nx">take_the_canonicalized_values</span>
              <span class="nx">Square</span><span class="p">.</span><span class="nx">RecursivelyComputable</span><span class="p">.</span><span class="nx">take_the_results_at_time</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="p">)(</span><span class="k">this</span><span class="p">)</span>
          <span class="p">)</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">@level</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nx">t</span> <span class="o">&lt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">@level</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
          <span class="nx">Square</span><span class="p">.</span><span class="nx">canonicalize</span><span class="p">(</span>
            <span class="nx">Square</span><span class="p">.</span><span class="nx">RecursivelyComputable</span><span class="p">.</span><span class="nx">sequence</span><span class="p">(</span>
              <span class="nx">Square</span><span class="p">.</span><span class="nx">RecursivelyComputable</span><span class="p">.</span><span class="nx">square_to_intermediate_map</span>
              <span class="nx">Square</span><span class="p">.</span><span class="nx">RecursivelyComputable</span><span class="p">.</span><span class="nx">take_the_canonicalized_values</span>
              <span class="nx">Square</span><span class="p">.</span><span class="nx">RecursivelyComputable</span><span class="p">.</span><span class="nx">take_the_results</span>
              <span class="nx">Square</span><span class="p">.</span><span class="nx">RecursivelyComputable</span><span class="p">.</span><span class="nx">intermediate_to_subsquares_map</span>
              <span class="nx">Square</span><span class="p">.</span><span class="nx">RecursivelyComputable</span><span class="p">.</span><span class="nx">take_the_canonicalized_values</span>
              <span class="nx">Square</span><span class="p">.</span><span class="nx">RecursivelyComputable</span><span class="p">.</span><span class="nx">take_the_results_at_time</span><span class="p">(</span><span class="nx">t</span> <span class="o">-</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">@level</span> <span class="o">-</span> <span class="mi">3</span><span class="p">))</span>
            <span class="p">)(</span><span class="k">this</span><span class="p">)</span>
          <span class="p">)</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">t</span> <span class="o">is</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">@level</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
          <span class="nx">@result</span><span class="p">()</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">t</span> <span class="o">&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">@level</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
          <span class="k">throw</span> <span class="s2">&quot;I can&#39;t go further forward than #{Math.pow(2, @level - 2)}&quot;</span>

  <span class="nv">Square.Seed::result_at_time = </span><span class="nf">(t) -&gt;</span>
    <span class="k">if</span> <span class="nx">t</span> <span class="o">is</span> <span class="mi">0</span>
      <span class="nx">Square</span><span class="p">.</span><span class="nx">canonicalize</span>
        <span class="nv">nw: </span><span class="nx">@nw</span><span class="p">.</span><span class="nx">se</span>
        <span class="nv">ne: </span><span class="nx">@ne</span><span class="p">.</span><span class="nx">sw</span>
        <span class="nv">se: </span><span class="nx">@se</span><span class="p">.</span><span class="nx">nw</span>
        <span class="nv">sw: </span><span class="nx">@sw</span><span class="p">.</span><span class="nx">ne</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">t</span> <span class="o">is</span> <span class="mi">1</span>
      <span class="nx">@result</span><span class="p">()</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">t</span> <span class="o">&gt;</span> <span class="mi">1</span>
      <span class="k">throw</span> <span class="s2">&quot;I can&#39;t go further forward than #{Math.pow(2, @level - 2)}&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <h2>Computing the future of a square</h2>

<p>Let's say we have a square and we wish to determine its future at time <code>t</code>.
We calculate the smallest square that could possible contain its future, taking
into account that the pattern in the square could grow once cell in each direction
per generation.</p>

<p>We take our square and 'pad' it with empty squares until it is large enough to
contain its future. We then double that square and embed our pattern in the center. This becomes our base
square: It's our square embdedded in a possible vast empty square. We then take the
base square's <code>result_at_time(t)</code> which gives us the future of our pattern.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">Cell</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span>
    <span class="nv">empty_copy: </span><span class="o">-&gt;</span>
      <span class="nx">Cell</span><span class="p">.</span><span class="nx">Dead</span>

  <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">Square</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span>
    <span class="nv">empty_copy: </span><span class="o">-&gt;</span>
      <span class="nv">empty_quadrant = </span><span class="nx">@nw</span><span class="p">.</span><span class="nx">empty_copy</span><span class="p">()</span>
      <span class="nx">Square</span><span class="p">.</span><span class="nx">canonicalize</span>
        <span class="nv">nw: </span><span class="nx">empty_quadrant</span>
        <span class="nv">ne: </span><span class="nx">empty_quadrant</span>
        <span class="nv">se: </span><span class="nx">empty_quadrant</span>
        <span class="nv">sw: </span><span class="nx">empty_quadrant</span>

    <span class="nv">pad_by: </span><span class="nf">(extant) -&gt;</span>
      <span class="k">if</span> <span class="nx">extant</span> <span class="o">is</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="k">this</span>
      <span class="k">else</span>
        <span class="nv">empty_quadrant = </span><span class="nx">@nw</span><span class="p">.</span><span class="nx">empty_copy</span><span class="p">()</span>
        <span class="nx">Square</span><span class="p">.</span><span class="nx">canonicalize</span>
          <span class="nv">nw: </span><span class="nx">Square</span><span class="p">.</span><span class="nx">canonicalize</span>
            <span class="nv">nw: </span><span class="nx">empty_quadrant</span>
            <span class="nv">ne: </span><span class="nx">empty_quadrant</span>
            <span class="nv">se: </span><span class="nx">@nw</span>
            <span class="nv">sw: </span><span class="nx">empty_quadrant</span>
          <span class="nv">ne: </span><span class="nx">Square</span><span class="p">.</span><span class="nx">canonicalize</span>
            <span class="nv">nw: </span><span class="nx">empty_quadrant</span>
            <span class="nv">ne: </span><span class="nx">empty_quadrant</span>
            <span class="nv">se: </span><span class="nx">empty_quadrant</span>
            <span class="nv">sw: </span><span class="nx">@ne</span>
          <span class="nv">se: </span><span class="nx">Square</span><span class="p">.</span><span class="nx">canonicalize</span>
            <span class="nv">nw: </span><span class="nx">@se</span>
            <span class="nv">ne: </span><span class="nx">empty_quadrant</span>
            <span class="nv">se: </span><span class="nx">empty_quadrant</span>
            <span class="nv">sw: </span><span class="nx">empty_quadrant</span>
          <span class="nv">sw: </span><span class="nx">Square</span><span class="p">.</span><span class="nx">canonicalize</span>
            <span class="nv">nw: </span><span class="nx">empty_quadrant</span>
            <span class="nv">ne: </span><span class="nx">@sw</span>
            <span class="nv">se: </span><span class="nx">empty_quadrant</span>
            <span class="nv">sw: </span><span class="nx">empty_quadrant</span>
        <span class="p">.</span><span class="nx">pad_by</span><span class="p">(</span><span class="nx">extant</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="nv">future_at_time: </span><span class="nf">(t) -&gt;</span>
      <span class="k">if</span> <span class="nx">t</span> <span class="o">&lt;</span> <span class="mi">0</span>
        <span class="k">throw</span> <span class="s2">&quot;We do not have a time machine&quot;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">t</span> <span class="o">is</span> <span class="mi">0</span>
        <span class="k">this</span>
      <span class="k">else</span>
        <span class="nv">new_size = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">@level</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="nv">new_level = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">new_size</span><span class="p">)</span> <span class="o">/</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="nv">base = </span><span class="nx">@pad_by</span> <span class="p">(</span><span class="nx">new_level</span> <span class="o">-</span> <span class="nx">@level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="nx">base</span><span class="p">.</span><span class="nx">result_at_time</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <h2>The first time through</h2>

<p>If this is your first time through the code, and you've already read the <a href="http:rules.html">Rules Module</a>, you can look at the <a href="http:cache.html">Cache</a>,
<a href="http:gc.html">Garbage Collection</a>, and <a href="http:api.html">API</a> modules.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <hr />

<p><strong>(c) 2012 <a href="http://braythwayt.com">Reg Braithwaite</a></strong> (<a href="http://twitter.com/raganwald">@raganwald</a>)</p>

<p>Cafe au Life is freely distributable under the terms of the <a href="http://en.wikipedia.org/wiki/MIT_License">MIT license</a>.</p>

<p>The annotated source code was generated directly from the <a href="https://github.com/raganwald/cafeaulife/blob/master/lib">original source</a> using <a href="http://jashkenas.github.com/docco/">Docco</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 